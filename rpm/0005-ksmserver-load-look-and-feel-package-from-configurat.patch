From 457ad93834374882cb2cfe4e044e22cf40c1b32e Mon Sep 17 00:00:00 2001
From: Pier Luigi Fiorini <pierluigi.fiorini@gmail.com>
Date: Thu, 3 Jul 2014 21:48:29 +0200
Subject: [PATCH 5/5] ksmserver load look and feel package from configuration

BUG:336844
---
 ksmserver/screenlocker/greeter/greeterapp.cpp | 9 ++++++++-
 ksmserver/shutdowndlg.cpp                     | 9 ++++++++-
 2 files changed, 16 insertions(+), 2 deletions(-)

diff --git a/ksmserver/screenlocker/greeter/greeterapp.cpp b/ksmserver/screenlocker/greeter/greeterapp.cpp
index 14bf3db..5cc694d 100644
--- a/ksmserver/screenlocker/greeter/greeterapp.cpp
+++ b/ksmserver/screenlocker/greeter/greeterapp.cpp
@@ -28,7 +28,9 @@ along with this program.  If not, see <http://www.gnu.org/licenses/>.
 #include <kworkspace.h>
 // KDE
 #include <KAuthorized>
+#include <KConfigGroup>
 #include <KCrash>
+#include <KSharedConfig>
 #include <KUser>
 #include <KWindowSystem>
 #include <Solid/PowerManagement>
@@ -104,9 +106,14 @@ void UnlockApp::initialize()
     KCrash::setDrKonqiEnabled(false);
 
     KScreenSaverSettings::self()->readConfig();
+
     ShellPluginLoader::init();
+
+    KConfigGroup kdeglobals(KSharedConfig::openConfig("kdeglobals"), QStringLiteral("General"));
+    const QString lookAndFeel = kdeglobals.readEntry(QStringLiteral("LookAndFeel"), QStringLiteral("org.kde.lookandfeel"));
+
     m_package = Plasma::PluginLoader::self()->loadPackage("Plasma/LookAndFeel");
-    m_package.setPath("org.kde.lookandfeel");
+    m_package.setPath(lookAndFeel);
 
     m_mainQmlPath = QUrl::fromLocalFile(m_package.filePath("lockscreenmainscript"));
 
diff --git a/ksmserver/shutdowndlg.cpp b/ksmserver/shutdowndlg.cpp
index ccf6dd9..be0a61d 100644
--- a/ksmserver/shutdowndlg.cpp
+++ b/ksmserver/shutdowndlg.cpp
@@ -44,6 +44,8 @@ CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #include <QScreen>
 
 #include <Plasma/PluginLoader>
+#include <KConfigGroup>
+#include <KSharedConfig>
 #include <kiconloader.h>
 #include <klocale.h>
 #include <kuser.h>
@@ -152,8 +154,13 @@ KSMShutdownDlg::KSMShutdownDlg( QWindow* parent,
     QString fileName;
     if(theme.isEmpty()) {
         ShellPluginLoader::init();
+
+        KConfigGroup kdeglobals(KSharedConfig::openConfig("kdeglobals"), QStringLiteral("General"));
+        const QString lookAndFeel = kdeglobals.readEntry(QStringLiteral("LookAndFeel"), QStringLiteral("org.kde.lookandfeel"));
+
         Plasma::Package pkg = Plasma::PluginLoader::self()->loadPackage("Plasma/LookAndFeel");
-        pkg.setPath("org.kde.lookandfeel");
+        pkg.setPath(lookAndFeel);
+
         fileName = pkg.filePath("logoutmainscript", QString());
     } else
         fileName = theme;
-- 
1.9.1

